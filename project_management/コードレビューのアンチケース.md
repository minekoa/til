# コードレビューのアンチケース

この文章は、コードレビューについてとても良くないことが起こった事例のメモである。
とはいえ幾分主観が強いので、体験談以上のものにならない可能性がある。

コードレビューのアンチ **パターン** については、以下の文章がおすすめ。

* [人間らしくコードレビューするには(パート1)](https://yakst.com/ja/posts/4907)
* [人間らしくコードレビューするには(パート2)](https://yakst.com/ja/posts/4965)
* [そろそろコードレビューそのものの必要性について考えるときがきているのかもしれない](https://hachibeechan.hateblo.jp/entry/code-review-is-not-required-process-to-win)

引用: [そろそろコードレビューそのものの必要性について考えるときがきているのかもしれない](https://hachibeechan.hateblo.jp/entry/code-review-is-not-required-process-to-win)

> しかし僕がここ数年で学んだ通り、そして色々な人がこぼす通り、コードレビューは利益もありますが、コストやリスクも存在します。
> というかコードレビューは**人間の自然なセンスで実施すると間違ったやり方をしてしまいます**。

ということなのだなぁ。

## コードレビューで..

新しいチームへのコミットメント研修で、プログラミング課題を与えられ、それを解き、コードレビューを受けるという
サイクルでチームに参加するための知識をキャッチアップしていくという、
ちょっとリッチなやりかただ。

## まさかりを投げると宣言された

(todo)

「おっ、ハッカー文化なんだな、いいよ、まさかり…」などと思っていた

## 「尊敬」と「信頼」を失う過程

さて、コードレビューの指摘は、まぁ、順調にすすむ。時折
リストのnth(0) は O(n) だから パタンマッチでヘッドを取り出していって…というコメントがついたが
O(n) なのは nth の問題ではなくってデータ構造自体の問題だから、
その理由はおかしいよね？というコメント返しをしたりした。

ここらへんまでは微笑ましく進行した。

最初に嫌な匂いがしたのは Maybe だ。エラーについて、Maybe や Either をつかい
do記法などでつなぐ書き方について、彼は難色をしめした。

どうも彼は Maybe がお嫌いのようだ。チームの文化だろうか？

しかしまずいにのは、それにロジックをつける過程で
半端な知識を振り回しているように感じた。例えば mapに対するlookup で
「複数ヒットするかもしれない」というようなコメントがついたとき、
基本的なデータ構造に対する理解が決定的に不足しているのでは無いかと思った。

であれば、このコードレビューの場で彼にも一緒に成長していってもらおう。
私は社内ライブラリの使い方を学び、WinWinだ、、と考えていた。

しかしある課題で、彼がしかめ面をしながらやってきたとき、
HRTが崩壊する音を聞いてしまった。

独自のデータベースアクセスライブラリの課題のとき、
私はデータベースの入力値に対し型チェック相当の処理を行うコードを記載した。
また、私はそれまでも作ったコードに対し必ずテストを記載していた。

これに対して彼はコードレビューが大変だから、入力値チェックはするな、
テストは書くな、と行ってきた。

DBに保存する入力値のチェックをしなくていいって？
ユニットテストはいらないって？

しかもその理由が「コードレビューするのが大変」という本音に基づきながら
「普通、そんな複雑な書き方しないよね」的な dis りをともなったものであった。これには強く反感を覚えました。

この当たりで私はもはや彼を尊敬することも信頼することもできないと考え始めた。
とはいえ、コードレビューで HRT (Humility, Respect, Trust) を失うのは良くないことのため、
問題点の洗い出しとその改善のトライを行うことでその場を収めた。

トライ:

* テストは書く。別コミットにしてレビュー対象から外す。
* 防衛的にコードは書かないという方針で課題を書く。通常の開発ではないのでゴールが違う。

実はこの2番目が曲者だったということに気づくのは後からのこと。
実はこの時点で「コードレビューの目的」が何なのか、誰にもわからなくなってしまっていて、
なんかコードレビューぽいやり取りをするだけのお遊戯とかしてしまっていたのです。

## アンチパターン: お姑レビュー

その後の彼のレビューは「気に食わない駆動」に見えた。
癇に障った箇所を直感のまま指摘している。

(todo)

明らかに彼が「癇に障った」箇所が指摘される傾向にある


そう感じてしまうと、私の方も彼の指摘を「一理ある」と見なせなくなってしまう。
そうして頭が加熱したままではいけない, 一旦時間をおかないと処理できないという状態になりつつあった。

## 負のサイクル

引用: [人間らしくコードレビューするには(パート2)](https://yakst.com/ja/posts/4965)

> 私とマロリーが同じレビューのやり取りをまだしていた火曜日のことでした。私は夕方に新しいコメントを書いていました。
> 私は彼女がそのレビューを読んでいる時に同じ部屋にいたくなかったので、その日は意図的に彼女が帰るまでそのままにしました。
>
> 午前中ずっと、次のレビューラウンドがとても怖かったので悪いことが起きそうな感覚をお腹の底に感じてました。
> 昼食から戻ったら、マロリーは不在でしたが新しい変更をリストをくれていたことに気が付きました。
> おそらく、彼女は私がその回答を読んでいるときに近くにいたくなかったのだとおもいます。
>
> 彼女の回答ごとに私の怒りはどんどん増長し私の心はズキズキし始めました。
> 私はすぐに反発心を持ちキーボードを叩き始め、彼女が私の提案した変更も実施するでもなく、
> その正当性について私に承認を求めてもいないことを指摘しました。

まさにこのパターンに近い状況になっていった。
コードレビューがストレスとなり、辛くて仕方がなく、相手の返答に目を通すと
平常心を失い、作業効率が大幅に起きる…という症状として表面化した。

また、相手側にしてもこのような精神状態で行われるレビューは
技術的に間違った指摘をしてしまうミスを誘発し、そこへの指摘を返し…という
悪循環がHRTをみるみる削っていくのです。


## 何が悪かったのか

相手の悪い方はよく見える。しかし自分の悪い点はよく見えないので、つい軽視してしまいがちだ。
（この手の自省文章を書くときにさえ「本当は俺が正しいのだけれども」という空気を漂わせてしまいがちだ）

### 1. どんな理由があっても、まさかりを投げたり投げ返してはいけない

これは、人が感情駆動で動く生き物である以上、守るべき大切なことだ。
リーナスがきれいなリーナスになったのも Political Correctness のせいであると思うべきではないと感じた。

### 2. 形式的な HRT を保つ行為は意味がない

行動だけのHRT .. たとえば、相手が間違っていると直感しても、いやそういうからには何か見落としている正しさがあるはずだ、
というところに立脚する行為は良いことと思っていた。
しかし、それは「嫌味」のようになる。そういうのは言葉の端々に滲み出るものだ。
にじみ出てしまえば、マウンティングと同じなのだ。

結論として, レビュワーとレビュイーで技術力を競ってはいけない。


### 3. コードレビューの目的（ゴール）を明確にしなかった

このコードレビューは何を目的にしているのかを明確にしなかった。
なんとなく「コードレビュー」という行為があるとして、コードレビューをしていたが、
レビュー後の事後状態はなんなんだろう。

たとえば、

引用: [そろそろコードレビューそのものの必要性について考えるときがきているのかもしれない](https://hachibeechan.hateblo.jp/entry/code-review-is-not-required-process-to-win)

> そしてコードレビューで最優先するべきなのはバグやセキュリティ上の欠陥、
> 明らかなパフォーマンス上の懸念など、プロダクトの価値を毀損しかねない問題をチェックすることです。
> 次は単体テストのコードに問題がないことでしょうか。

という視点については、レビュワーの「テスト書くな、値チェックするな」要求を飲んだ結果、
完全にむさんしました。
テストはレビューから外す…というトライで守れましたが、値チェックは守れませんでした。

一方で、それは良くないけどレビュワーの責任だよ、とする気持ちもあって
「やってないけど、こういう前提だからだよ」というコメントを書いていたのですが、
（指摘されたらたまらん）
それも嫌味のようで、彼の癇に障ったようでした。

## 改善してほしかったこと

最大の要求は
コードレビューにはプログラミングやドメインの知識だけでなく、
「コードレビューの技術」というものが必要なことを認識してほしかった。

コードレビューとは、誰かのコードを自分のコードに置き換えさせることではない。
自分の書くようなコードを作る行為ではない。

### 1. 「コードを綺麗に」するレビュー

うまく言葉にできないけれど,

引用: https://hachibeechan.hateblo.jp/entry/code-review-is-not-required-process-to-win

> 反して、「コードを綺麗に」するためのレビューは簡単です。
> なぜなら各レビュワーの知識ベースでコードの表面をなぞればよく、
> 最悪コードの意味をあまり理解しなくても簡潔に書き換えることができます。

「美しい」と言い換えても良いかもしれない。

* コードゴルフ的な指摘
* コメント削れ。最小を目指せ。
* 寛容さの欠如
    * 「この関数名ならば n文字短くなる」は禁止してほしい

という指摘に対し「これが正しい、直せ」は大いに反感を覚える。

「美観」という主観にもとづくレビュー指摘は全面禁止にすべきではないか？
（スタイル標準を用意し、それに準拠すること…という指摘以外は不法とすべき）


引用: https://yakst.com/ja/posts/4965

> ### コードを1段階か2段階向上させることを目標にする
>
> 論理上はチームメイトはコードを改善するためにすべての機会を探し求めているはずですが、
> 彼らの忍耐にも限界があります。
> 彼らの変更リストを改善する新しくよりよい方法をあなたが考え続け何ラウンドも承認せずにいると、
> 彼らの苛立ちはすぐに募ります。

### 2. 寛容さの欠如

ザンダクロスアンチパターン
(todo)

### 2. 正しい（と思っているならば）何を行っても良いという態度

* 「自明である」はマウンティング行為だと認識しよう
* 否定から入る
    * 理解から入ろう

引用: [コードレビューを円滑に行いたい (#cross2014 のお話)](https://blog.shibayu36.org/entry/2014/01/19/180201)

> こういう反省があって、最近はチーム内や自分自身で幾つか気をつけている事がある。例えば
>
> * 「こうしなさい」ではなく、「こうしたら良くなりそうだけどどう思う？」
> * 文字情報は情報量が少ない


### 3. 他の文化をしらない（あるいは単純にしらない）ということを素直にみとめる

文化の違い、バックボーンの違いで住む話が、一般的で汎用的な正しさの話になります。
レビュワーはレビュイーに「教わる」ということを恥じてはならぬのです。
(HRTが本当になされていれば、自然とそうなるはずです）


### 4. 教化を目的としていないか？

引用: [レビュアーとレビュイーの関係に関して | 職質アンチパターン](https://moznion.hatenablog.com/entry/2014/01/18/184710)

> あとレビューされた内容は素直に受け入れるべきだと思うけれど，盲目的になってはならないとも思う．
> 全てを額面通り受け入れることが当たり前になると，レビューは実装の洗練だとか，レビュイーの成長だとか，
> そういうことが目的ではなくなって，単なるレビュアーによる教化が目的になってしまう

## チームに望むこと

これは「チーム」ではないと感じる。週間進捗会議をハックする形で改善にトライしたが、これは良くない。
チームであるためには、振り返り(KPT)はほしい。
