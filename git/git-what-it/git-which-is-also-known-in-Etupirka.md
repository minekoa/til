# エトピリカでもわかるGit

{{TOC}}

## Gitとは

!gitとは.jpg!



基本的には、日付フォルダを作る→プロジェクト全体をその中にコピーする ... という原始的なバージョン管理を
そのままスマートにしたのが git

コピーの仕方が賢かったり、ファイルをコピーするときに圧縮してたりするくらいの違いと思って良い。

----

## git(リポジトリ)の構成

### .gitフォルダ(=リポジトリ)の中には

!gitフォルダの中には.jpg!

----

### BLOBオブジェクトとは

!blobとは.jpg!

* ハッシュ計算をすると、内容が同じならば同じ値が、内容が違うのであれば違う値が得られる。これがGitの構造と仕組みを支えている
* SHA-1 はハッシュを計算するアルゴリズムの名前
* ハッシュ値 = Gitオブジェクトの名前(ID)は、40文字の16進数で表現される

----

### TREEオブジェクトとは

!Treeとは.jpg!

* あともう一つこの構造で美味しいのは、コミット間で変わっていないファイルのBLOBは作りなおされないこと

----

### COMMITオブジェクトとは

!commitとは.jpg!

----

### TAGオブジェクトとは

（今回はスキップ）

以下、今は知らなくても良い情報。

> Git のタグには「軽量タグ」と「アノテートタグ」の二種類があって、タグ名をしたリファレンスが作られるところまでは一緒なのだけれども、差す先が違う。TAGオブジェクトが作られるのはアノテートタグの方のみ。軽量タグの場合、直接コミットログを差す。
> 
> <pre>
> git tag 【タグ名】
> </pre>
> 
> では軽量タグが作られるが、
> 
> <pre>
> git tag -a 【タグ名】　
> </pre>
> 
> で、アノテートタグが作られる（エディタが立ち上がり、コミットの時とおなじくコメントを入力する）
> 
> つまり、TAGオブジェクトはTAGについての注釈を保存するために作られるオブジェクトのこと

----

## ローカルのバージョン管理


### やってみよう！ git init

!git-init.jpg!


----

### やってみよう！git add

!git-add.jpg!

* index に add することをステージングといったりする
* 「コミットのためにステージに上げる」的な説明で「嘘」になるのは、index は commit しても別に空になったりしないこと

----

### やってみよう！git commit

!git-commit.jpg!

補足

コミット情報に必要なため、user.name と user.email の設定がコンフィグされていることが要求される。

```
git config user.name "おなまえ"
git config user.email "めーるあどれす"
```

で設定（通常は、リポジトリ毎に設定してらんないので、git config --global で設定する）

----

### まとめ

* add して commit。
* 構造上、ステージングできるのはファイルだけ。
** そこから孫引きで、空のTREEは作れないよ！
* COMMITオブジェクトのチェーンが変更の歴史だけれども、そこに「ブランチ名」を与えているのはリファレンス"refs/heads/おなまえ" なんじゃね？ git checkout は HEAD を書き換えてるだけなんじゃね？
** …というごもっともな疑問は、自身でいろいろ遊んで確かめてみてください。
* 巷でよく言う「歴史の改ざん(git rebase)」って、COMMIT オブジェクトを自由に編集してるだけなんじゃね？
** …というごもっともな疑問は（以下略）

----

### おまけ:便利なコマンドと便利なオプション

ステージングしたい

|command|説明|
|-------|-------|
|git add <file>| ファイルをindexに追加。実はファイルパスにはワイルドカードも使えるのは、クラスのみんなには内緒だよ！|
|git add <directory> |ディレクトリ配下のファイルをすべてadd|
|git add -u|既にリポジトリに追加されているファイルについて、更新があるものを全部追加|
|git add -p|対話型ステージングを開始！diffが順番に表示されるので y or n でステージするかを選択する。あるファイルの一部分だけaddしたいとか出来る|
|git rm <file>| 「ファイルを削除する」という変更をindexに追加（=indexから対象を削除)|

* ファイルの移動（あるいはリネーム）は、git mv <oldfile> <newfile> は、rm して add するのと全く同じ。
* git は操作ではなく結果を覚えているので、移動は同じハッシュ値のオブジェクトが別の TREEの子になってたりするのを「移動したんだな」と推測しているだけ

ステージングを取り消したい

|command|説明|
|-------|-------|
|git reset HEAD <ファイル名とかディレクトリ名とか>|git add しちゃったものを取り消したい|
|git reset HEAD|も～、全部のステージングを取り消して最初からやり直したい|

* git reset は COMMITからindexを作るコマンドです（git commit の逆だと思えばいい)
* 特定ファイルのadd取り消しは git rm --cached <file> (indexからファイルを取り除くけれどもワークツリーはそのままにしておく)でもできる。

コミットしたい

|command|説明|
|-------|-------|
|git commit -m <コミットメッセージ>|いちいちテキストエディタを起動したくないときにどうぞ|
|git commit -a|過去にステージされたファイルのうち、更新があるものを勝手にaddしてコミットする、ものぐさ向けのオプション|
|git commit --allow-empty|何も修正ないのにコミットシたい場合。うちのチームでは「コードレビュー、指摘なし」とかコミットするのによく使う|

コミットを取り消したい

|command|説明|
|-------|-------|
|git commit --ammend|直前のコミットを無かったことにして、新たなコミットを行う「やりなおし」。add し忘れた！とかのときに有用。|
|git reset --soft|直前のコミットを無かったことにする。ワークディレクトリの内容は維持。(内部では、HEADの指している先をひとつ前のコミットオブジェクトに戻してるだけ)|
|git reset --hard|直前のコミットを無かったことにする。ワークディレクトリも全部消す|

今どうなってる系

|command|説明|
|-------|-------|
|git status|だいたい全部見れる(ワークディレクトリとindexとHEADの差を親切に説明)|
|git diff  |indexとワークディレクトリの差分を表示(ただし、ワークディレクトリに新しく追加したファイルは対象外)|
|git diff --cached|HEADとindexの差分|
|git show|最後のコミットのコメントと差分を表示。git diff HEAD^ HEAD よりはタイプが楽なのが良い|

----

## リポジトリ間の変更の同期

（未稿）

### リポジトリ間の同期とはこういうものか！？

!pull1.jpg!

* 外部のリポジトリの内容を自分のリポジトリに取ってくる pull とか fetch とかいうコマンドがあるので、これを使えば同期はできる。
* なのでお互いのリポジトリをお互いからアクセス可能にしておけば（共有に設定）、同期はできる。

---

### pull とは？

* 相手のリポジトリの状態を、自分のリポジトリに取り込む
* 自分のHEADやワークディレクトリの状態と、相手リポジトリの修正を取り込んだことによる更新分を自分の *合わせこむ*

という2つの作業をするコマンド

!pull2.jpg!

なので、最初の例のように二人が「相手の編集を受け取るまで自分の編集を待つ」をやる場合とか、二人が「同時に作業するが作業箇所が別」の場合は問題ないが、運悪く編集箇所が衝突する場合、merge部分でコンフリクトが発生する場合がある。

この場合は人間が解決する。

...これ以上面倒くさい話は「二つの歴史を一つにする」で。

----

### 共有リポジトリを置こう（push と、 bare で shared なリポジトリ）

!push1.jpg!

* push はリポジトリ側にそれを受け入れる設定をしていないとできない
* あと、push すると ローカルのユーザーの修正と pushによる修正で index が壊れるので、通常ワークディレクトリのない「むき出しの」リポジトリを作る。

----

### リポジトリーのクローン

実際にやってみよう!

## 二つの歴史を一つにする

### checkout (念のため)

.git/HEAD の指している先を切り替えること。

----

### marge と rebase

!merge-and-rebase.jpg!


----

### コンフリクトの解消

----


----

### 歴史の改ざん

（未稿）
