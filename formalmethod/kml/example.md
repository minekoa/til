# KML文法を思い出す

色々忘れた。覚えている限りで思い出す

客観資料

[《日経Robo》ファナックが買収したロボベンチャー、ソフトの技術力で群を抜く](https://tech.nikkeibp.co.jp/dm/atcl/mag/15/00140/00017/?P=2)



## オーバービュー

```
event = e1@(いーいち)
      | (e2 of Int)@(いーに)
      | e3@(いーさん)

state Foo@(ふー) {
   var stat_v1 : Int = 0;
   var stat_v2 : String List = [];

   invaliant {
       length stat_v2 <= 0;
   }

   transition e1 --> {
        post {
        }@{- ふがー -}
   }@{- ふがー -}

   transition e2(n)
         when n > 3
   --> {
        post {
        }@{- ふがー -}
   }@{- ふがー -}
}
```
たしかこんな感じ。イベント定義の書き方は自信ない。
セミコロンターミネートな言語だったけれども、
postとかの中では 論理和で読み替えるんじゃなかったかな。

## 状態遷移

実質 CSPだったので transition を外部選択□と読み替えてもOK

```
   □ e1 --> {
        post {
        }@{- ふがー -}
   }@{- ふがー -}
```

（なんか、こういう感じの後継言語作ってたな）


なので、あるイベントにたいして成功したり失敗したりは運次第
的な動作（内部選択）を書くには、

```
 (a -> b -> P) □ (a -> c -> P)
      = a -> ((b -> P) ⊓ (c -> P))
```
 を利用して、同じイベント（とガード条件）を２つかいて postを違えればいい

## 事後条件

事後条件は、事前の状態をつかって事後の状態を表現したもの。
状態は変数になっているので `hoge` の事後変数は `hoge'` に勝手になるルール。
でこの変数の状態を事前の状態で示して等号 `=` でつなぐ。

本当は、
変わってないものも変わってないことを明示 (たとえば `hoge' = hoge` )する必要があるけど
それは大変なので
```
   post {
       target foo, var, buz;
   }
```
と書いたら target したもの以外は変化していない、という文法。

ローカル変数は let式で作るのだけれども、

```
   v' = let
          hoge = 1 + v
        in
          hoge
```
みたいな感じだったと思う。


あとセミコロンターミーとじゃなくなった記憶が

```
   v' = let
          hoge = 1 + v &&
          piyo = 2 + v
        in
          hoge
```
だっけなー。こっちはセミコロンでいけたっけな？覚えてない。

それとこんな感じでかけたんじゃないかな、たしか

```
   let
      hoge = 1 + v
   in
      v' = hoge     &&
      x' = hoge * 2
```

= は代入文じゃなく等号なので。

## 関数定義、型定義

普通の関数言語的なことは全部できた。OCaml と VDM のちゃんぽんという
文法だったはず。
（集合とかリストとかは VDMベースで、代数データ型が OCamlベースだったっけ？）
あとちょいHaskell。

関数定義できるけれど、どこまでも定義していると
プログラムと同じ抽象度になっちゃったりするし
既存システムの仕様とかでやってられないときがあったり
書くのすっごく大変だたりするときは `given` を与えてそれっぽく

## チャネル通信

チャネル通信はたしかこんな感じ

```
chan chan1;
chan chan2;

state Foo {
    transition (chan1 ? data1) --> {
        post {
            target state;


            state' = (chan2 ! data2) -> state;
        }
     }
}
```

CSPでは `chan ? value`、`chan ! value` は イベントなので
こうかけるはず。
state は予約後でもあるけれども、状態変数でもあるのでこういうことができる

外部向けAPIとかこんな感じで書いてた。

## ページ間繊維

たしか `entry` とか言う名前のイベント作ってたはず。

`state Hoge` は 抽象化された状態なのだけれども
もちろん外に出てしまえば内部変数の状態は保存されないので。

でもページ遷移後も残っていてほしいやつとかあるでしょ。
そういうのは グローバル変数 `g` に退避して、復帰するとかやってた

で、その復帰のトリガーが `entry`。

これ意味的にはどうだったのかな。勝手に呼ばれるとかだったけ。
あと引数取れたっけ？記憶にない。

## グローバル変数

環境（例えばプログラム外のファイルシステムとか）とか、ページ間保持情報とか、
時刻とか（インターバルな内部イベントが起きて更新された現在時刻を収めていく）
ログとか保存先。

便利だったけれど、よくない・やめときゃよかった言ってた。

そこらへんわたしゃ全然理解できてないけれど。

## タウ

時刻とかでつかってたはず。記法どうだったけ？

## サブプロセスに移動

モーダルダイアログとかのときに使ってた。
全然思い出せないけれど

```
  state' = (OkCanDialog "title" "defaultValue") ||{ok, can}|| state;
```

とかやってたのだっけ？本当に思い出せない。
